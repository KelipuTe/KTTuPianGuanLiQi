<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>KT图片管理器</title>
    <link rel="stylesheet" href="bu_ju.css">
    <link rel="stylesheet" href="zu_jian.css">
    <script src="quan_ju.js"></script>
    <script src="you_ji_cai_dan.js"></script>
</head>
<body>
<div class="zhu-rong-qi">
    <div class="zheng-ti-zuo">
        <div>
            <div id="xuan-ze-mu-lu" class="an-niu-zhong an-niu-lan">选择目录</div>
            <div id="mu-lu-lu-jing"></div>
        </div>
        <div id="tu-pian-lie-biao"></div>
    </div>
    <div class="zheng-ti-zhong">
        <img id="tu-pian-zhan-shi" src="" alt="图片展示">
    </div>
    <div class="zheng-ti-you">
        <div id="biao-qian-lie-biao" class="biao-qian-lie-biao">
            <label class="biao-qian-an-niu">
                <span>分类标签</span>
            </label>
            <label class="biao-qian-an-niu">
                <span>额外标签</span>
            </label>
        </div>
        <div id="biao-qian-yei-lie-biao" class="biao-qian-yei-lie-biao">
            <div style="display: block">
                <div style="height: 20px">
                    一级分类标签
                </div>
                <div id="yi-ji-lie-biao" style="height: 250px">

                </div>
                <div style="height: 30px">
                    <input id="yi-ji-id" type="text" style="width: 80px" aria-label="一级Id"/>
                    <input id="yi-ji-ming" type="text" style="width: 80px" aria-label="一级标签名"/>
                    <div id="yi-ji-tian-jia" class="an-niu-zhong button-lan" role="button">添加一级标签</div>
                </div>
                <div style="height: 20px">
                    二级分类标签
                </div>
                <div id="er-ji-lie-biao" style="height: 250px">

                </div>
                <div style="height: 30px">
                    <input id="er-ji-shu-ru" type="text" aria-label="二级标签名"/>
                    <div id="er-ji-tian-jia" class="an-niu-zhong button-lan" role="button">添加二级标签</div>
                </div>
            </div>
            <div style="display: none">额外标签</div>
        </div>
        <div>确认移动</div>
    </div>
</div>
<script>

    let caoZuoMuLu = '';
    let tuPianMuLu = '';
    let biaoQianMuLu = '';
    let tuPianLieBiao = [];
    let tuPianShuLiang = 20;
    let btnXuanZeMuLu = {};
    let divTuPianLieBiao = {};
    let biaoQianLieBiao = [];
    let biaoQianYeLieBiao = [];

    let yiJiBiaoQian = [];
    let yiJiXuanZhongId = '';
    let yiJiErJiFenZu = [];
    let erJiBiaoQian = [];
    let erJiXuanZhongId = '';
    let sanJiBiaoQian = [];
    let sanJiXuanZhongIdLieBiao = [];

    let eleYiJiBiaoQian = {};
    let eleYiJiIdShuRu = {};
    let eleYiJiMingShuRu = {};
    let eleYiJiTianJia = {};
    let eleErJiBiaoQian = {};
    let eleErJiIdShuRu = {};
    let eleErJiMingShuRu = {};
    let eleErJiTianJia = {};

    window.onload = function () {
        biaoQianLieBiao = document.getElementById('biao-qian-lie-biao').children;
        biaoQianYeLieBiao = document.getElementById('biao-qian-yei-lie-biao').children;
        for (let i = 0; i < biaoQianLieBiao.length; i++) {
            biaoQianLieBiao[i].id = 'biao-qian-' + i;
            biaoQianLieBiao[i].onclick = function () {
                for (let j = 0; j < biaoQianLieBiao.length; j++) {
                    biaoQianLieBiao[j].className = 'biao-qian-an-niu';
                    biaoQianYeLieBiao[j].style.display = 'none';
                }
                let idIndex = this.id.replace('biao-qian-', '');
                biaoQianYeLieBiao[idIndex].style.display = 'block';
            }
        }

        btnXuanZeMuLu = document.getElementById('xuan-ze-mu-lu');
        btnXuanZeMuLu.onclick = xuanZeMuLu;
        divTuPianLieBiao = document.getElementById('tu-pian-lie-biao');

        eleYiJiBiaoQian = document.getElementById('yi-ji-lie-biao');
        eleYiJiIdShuRu = document.getElementById('yi-ji-id');
        eleYiJiMingShuRu = document.getElementById('yi-ji-ming');
        eleYiJiTianJia = document.getElementById('yi-ji-tian-jia');
        eleYiJiTianJia.onclick = tianJiaBiaoQian;
        eleErJiBiaoQian = document.getElementById('er-ji-lie-biao');
        eleErJiIdShuRu = document.getElementById('er-ji-id');
        eleErJiMingShuRu = document.getElementById('er-ji-ming');
        eleErJiTianJia = document.getElementById('er-ji-tian-jia');
        eleErJiTianJia.onclick = tianJiaBiaoQian;
    }

    function xuanZeMuLu() {
        // 选择目录
        GDialog.showOpenDialog({
            'title': '请选择操作目录',
            'properties': ['openDirectory']
        }).then(function (result) {
            caoZuoMuLu = result.filePaths[0];
            tuPianMuLu = caoZuoMuLu + '\\' + GWeiFenLeiMuLu;
            biaoQianMuLu = caoZuoMuLu + '\\' + GBiaoQianMuLu;
            huoQuTuPianLieBiao();
            huoQuBiaoQian();
        });
    }

    function huoQuTuPianLieBiao() {
        // 获取图片列表
        let jiShu = 1;
        GFs.readdir(tuPianMuLu, function (yiChang, wenJianLieBiao) {
            tuPianLieBiao = [];
            divTuPianLieBiao.innerHTML = '';
            if (yiChang === null) {
                for (let wenJianMing of wenJianLieBiao) {
                    if (jiShu > tuPianShuLiang) {
                        break;
                    }
                    tuPianLieBiao.push(wenJianMing);
                    let tempDiv = document.createElement('div');
                    tempDiv.id = 'tu-pian-lie-biao-' + jiShu;
                    tempDiv.className = 'an-niu-tu-pian';
                    tempDiv.innerHTML = wenJianMing;
                    tempDiv.onclick = xuanZeTuPian;
                    divTuPianLieBiao.appendChild(tempDiv);
                    ++jiShu;
                }
            }
        });
    }

    function xuanZeTuPian() {
        // 选择图片
        let wenJianMing = this.textContent;
        let tuPianLuJing = tuPianMuLu + '\\' + wenJianMing;
        let eleTuPianZhanShi = document.getElementById('tu-pian-zhan-shi');
        eleTuPianZhanShi.onload = function () {
            // 图片加载的时候计算偏移量，让图片居中
            let imgWidth = this.width;
            let imgHeight = this.height;
            let tuPianKuanDu = imgWidth;
            let tuPianGaoDu = imgHeight;
            let imgMarginLeft = 0;
            let imgMarginTop = 0;
            if (imgWidth <= GImgMaxWidth && imgHeight <= GImgMaxHeight) {
                // 宽高都小于限制，直接计算偏移量
                imgMarginLeft = Math.round((GImgMaxWidth - imgWidth) / 2 * 100) / 100;
                imgMarginTop = Math.round((GImgMaxHeight - imgHeight) / 2 * 100) / 100;
            } else if (imgWidth <= GImgMaxWidth && imgHeight > GImgMaxHeight) {
                // 只有宽度超过限制，单独计算高度偏移量
                imgWidth = Math.round(imgWidth * (GImgMaxHeight / imgHeight));
                imgMarginLeft = Math.round((GImgMaxWidth - imgWidth) / 2 * 100) / 100;
            } else if (imgWidth > GImgMaxWidth && imgHeight <= GImgMaxHeight) {
                // 只有高度超过限制，单独计算宽度偏移量
                imgHeight = Math.round(imgHeight * (GImgMaxWidth / imgWidth));
                imgMarginTop = Math.round((GImgMaxHeight - imgHeight) / 2 * 100) / 100;
            } else if (imgWidth > GImgMaxWidth && imgHeight > GImgMaxHeight) {
                // 只有宽高都超过限制，判断哪个超的更多，需要同比压缩
                if ((imgWidth / GImgMaxWidth) >= (imgHeight / GImgMaxHeight)) {
                    imgHeight = Math.round(imgHeight * (GImgMaxWidth / imgWidth));
                    imgMarginTop = Math.round((GImgMaxHeight - imgHeight) / 2 * 100) / 100;
                } else {
                    imgWidth = Math.round(imgWidth * (GImgMaxHeight / imgHeight));
                    imgMarginLeft = Math.round((GImgMaxWidth - imgWidth) / 2 * 100) / 100;
                }
            }
            this.setAttribute('style', 'margin-left: ' + imgMarginLeft + 'px; margin-top: ' + imgMarginTop + 'px');
        };
        eleTuPianZhanShi.src = tuPianLuJing;
    }

    function tianJiaBiaoQian() {
        let eleId = this.id;
        if (eleId === 'yi-ji-tian-jia') {
            let bianQianId = eleYiJiIdShuRu.value;
            let biaoQianMing = eleYiJiMingShuRu.value;
            if (gEmpty(bianQianId) || gEmpty(biaoQianMing)) {
                alert('一级标签数据缺失');
                return;
            }
            yiJiBiaoQian[bianQianId] = biaoQianMing;
            yiJiErJiFenZu[bianQianId] = {};
            GFs.opendir(biaoQianMuLu, function (yiChang, muLu) {
                if (yiChang !== null) {
                    GFs.mkdirSync(biaoQianMuLu);
                } else {
                    muLu.close();
                }
                GFs.writeFileSync(biaoQianMuLu + 'yiJiBiaoQian.json', JSON.stringify(yiJiBiaoQian), 'utf8');
                eleYiJiIdShuRu.value = '';
                eleYiJiMingShuRu.value = '';
            });
            let muBiaoMuLu = caoZuoMuLu + '\\' + bianQianId
            GFs.opendir(muBiaoMuLu, function (yiChang, muLu) {
                if (yiChang !== null) {
                    GFs.mkdirSync(muBiaoMuLu);
                } else {
                    muLu.close();
                }
            });
        } else if (eleId === 'er-ji-tian-jia') {
            if (gEmpty(yiJiXuanZhongId)) {
                alert('未选择一级标签');
                return;
            }
            let bianQianId = eleErJiIdShuRu.value;
            let biaoQianMing = eleErJiMingShuRu.value;
            if (gEmpty(bianQianId) || gEmpty(biaoQianMing)) {
                alert('二级标签数据缺失');
                return;
            }
            erJiBiaoQian[bianQianId] = biaoQianMing;
            if (gEmpty(this.yiJiErJiFenZu[this.yiJiXuanZhongId])) {
                this.yiJiErJiFenZu[this.yiJiXuanZhongId] = {};
            }
            this.yiJiErJiFenZu[this.yiJiXuanZhongId][this.erJiBiaoQianId] = this.erJiBiaoQianMing;
            GFs.opendir(this.biaoQianMuLu, function (yiChang, muLu) {
                if (yiChang !== null) {
                    GFs.mkdirSync(thisVue.biaoQianMuLu);
                } else {
                    muLu.close();
                }
                GFs.writeFileSync(thisVue.biaoQianMuLu + 'yiJiErJiFenZu.json', JSON.stringify(thisVue.yiJiErJiFenZu), 'utf8');
                thisVue.erJiBiaoQianId = '';
                thisVue.erJiBiaoQianMing = '';
            });
            let muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiXuanZhongId + '\\' + this.erJiBiaoQianId;
            GFs.opendir(muBiaoMuLu, function (yiChang, muLu) {
                if (yiChang !== null) {
                    GFs.mkdirSync(muBiaoMuLu);
                } else {
                    muLu.close();
                }
            });
        }
    }

    function huoQuBiaoQian() {
        // 获取保存在文件里的标签
        GFs.readFile(biaoQianMuLu + 'yiJiBiaoQian.json', 'utf8', function (yiChang, yiJiBiaoQianJson) {
            if (yiChang === null) {
                eleYiJiBiaoQian.innerHTML = '';
                yiJiBiaoQian = JSON.parse(yiJiBiaoQianJson);
                for (let biaoQian in yiJiBiaoQian) {
                    let tempBtn = document.createElement('div');
                    tempBtn.id = biaoQian
                    tempBtn.innerHTML = yiJiBiaoQian[biaoQian];
                    tempBtn.className = 'an-niu-xiao an-niu-lan';
                    eleYiJiBiaoQian.appendChild(tempBtn);
                    tempBtn.onclick = function () {
                        eleErJiBiaoQian.innerHTML = '';
                        erJiBiaoQian = yiJiErJiFenZu[this.id];
                        for (let biaoQian2 in erJiBiaoQian) {
                            let tempBtn = document.createElement('div');
                            tempBtn.id = biaoQian
                            tempBtn.innerHTML = erJiBiaoQian[biaoQian2];
                            tempBtn.className = 'an-niu-xiao an-niu-lan';
                            eleErJiBiaoQian.appendChild(tempBtn);
                        }
                    };
                }
            }
        });
        GFs.readFile(biaoQianMuLu + 'yiJiErJiFenZu.json', 'utf8', function (yiChang, yiJiErJiFenZuJson) {
            if (yiChang === null) {
                yiJiErJiFenZu = JSON.parse(yiJiErJiFenZuJson);
            }
        });
        GFs.readFile(biaoQianMuLu + 'sanJiBiaoQian.json', 'utf8', function (yiChang, sanJiBiaoQianJson) {
            if (yiChang === null) {
                sanJiBiaoQian = JSON.parse(sanJiBiaoQianJson);
            }
        });
    }
</script>
<script>
    //         tianJiaBiaoQian: function (jiBie) {
    //             // 添加标签，并写入文件
    //             let thisVue = this;
    //             if (jiBie === 1) {
    //                 if (gEmpty(this.yiJiBiaoQianId) || gEmpty(this.yiJiBiaoQianMing)) {
    //                     alert('一级标签数据缺失');
    //                     return;
    //                 }
    //                 this.yiJiBiaoQian[this.yiJiBiaoQianId] = this.yiJiBiaoQianMing;
    //                 this.yiJiErJiFenZu[this.yiJiBiaoQianId] = {};
    //                 GFs.opendir(this.biaoQianMuLu, function (yiChang, muLu) {
    //                     if (yiChang !== null) {
    //                         GFs.mkdirSync(thisVue.biaoQianMuLu);
    //                     } else {
    //                         muLu.close();
    //                     }
    //                     GFs.writeFileSync(thisVue.biaoQianMuLu + 'yiJiBiaoQian.json', JSON.stringify(thisVue.yiJiBiaoQian), 'utf8');
    //                     thisVue.yiJiBiaoQianId = '';
    //                     thisVue.yiJiBiaoQianMing = '';
    //                 });
    //                 let muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiBiaoQianId;
    //                 GFs.opendir(muBiaoMuLu, function (yiChang, muLu) {
    //                     if (yiChang !== null) {
    //                         GFs.mkdirSync(muBiaoMuLu);
    //                     } else {
    //                         muLu.close();
    //                     }
    //                 });
    //             } else if (jiBie === 2) {
    //                 if (gEmpty(this.yiJiXuanZhongId)) {
    //                     alert('未选择一级标签');
    //                     return;
    //                 } else if (gEmpty(this.erJiBiaoQianId) || gEmpty(this.erJiBiaoQianMing)) {
    //                     alert('二级标签数据缺失');
    //                     return;
    //                 }
    //                 this.erJiBiaoQian[this.erJiBiaoQianId] = this.erJiBiaoQianMing;
    //                 if (gEmpty(this.yiJiErJiFenZu[this.yiJiXuanZhongId])) {
    //                     this.yiJiErJiFenZu[this.yiJiXuanZhongId] = {};
    //                 }
    //                 this.yiJiErJiFenZu[this.yiJiXuanZhongId][this.erJiBiaoQianId] = this.erJiBiaoQianMing;
    //                 GFs.opendir(this.biaoQianMuLu, function (yiChang, muLu) {
    //                     if (yiChang !== null) {
    //                         GFs.mkdirSync(thisVue.biaoQianMuLu);
    //                     } else {
    //                         muLu.close();
    //                     }
    //                     GFs.writeFileSync(thisVue.biaoQianMuLu + 'yiJiErJiFenZu.json', JSON.stringify(thisVue.yiJiErJiFenZu), 'utf8');
    //                     thisVue.erJiBiaoQianId = '';
    //                     thisVue.erJiBiaoQianMing = '';
    //                 });
    //                 let muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiXuanZhongId + '\\' + this.erJiBiaoQianId;
    //                 GFs.opendir(muBiaoMuLu, function (yiChang, muLu) {
    //                     if (yiChang !== null) {
    //                         GFs.mkdirSync(muBiaoMuLu);
    //                     } else {
    //                         muLu.close();
    //                     }
    //                 });
    //             } else if (jiBie === 3) {
    //                 if (gEmpty(this.sanJiBiaoQianId) || gEmpty(this.sanJiBiaoQianMing)) {
    //                     alert('额外标签数据缺失');
    //                     return;
    //                 }
    //                 this.sanJiBiaoQian[this.sanJiBiaoQianId] = this.sanJiBiaoQianMing;
    //                 GFs.opendir(this.biaoQianMuLu, function (yiChang, muLu) {
    //                     if (yiChang !== null) {
    //                         GFs.mkdirSync(thisVue.biaoQianMuLu);
    //                     } else {
    //                         muLu.close();
    //                     }
    //                     GFs.writeFileSync(thisVue.biaoQianMuLu + 'sanJiBiaoQian.json', JSON.stringify(thisVue.sanJiBiaoQian), 'utf8');
    //                     thisVue.sanJiBiaoQianId = '';
    //                     thisVue.sanJiBiaoQianMing = '';
    //                 });
    //             }
    //         },
    //         xuanZhongBiaoQian: function (jiBie, biaoQianId) {
    //             // 选中标签
    //             if (jiBie === 1) {
    //                 // 一级标签互斥，同时获取二级标签
    //                 if (this.yiJiXuanZhongId === biaoQianId) {
    //                     this.yiJiXuanZhongId = '';
    //                     this.erJiBiaoQian = {};
    //                     this.muBiaoMuLu = '';
    //                 } else {
    //                     this.yiJiXuanZhongId = biaoQianId;
    //                     this.erJiBiaoQian = gEmpty(this.yiJiErJiFenZu[biaoQianId]) ? {} : this.yiJiErJiFenZu[biaoQianId];
    //                     this.muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiXuanZhongId + '\\'
    //                         + (gEmpty(this.erJiXuanZhongId) ? '' : this.erJiXuanZhongId + '\\');
    //                 }
    //             } else if (jiBie === 2) {
    //                 // 二级标签互斥
    //                 if (this.erJiXuanZhongId === biaoQianId) {
    //                     this.erJiXuanZhongId = '';
    //                     this.muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiXuanZhongId + '\\';
    //                 } else {
    //                     this.erJiXuanZhongId = biaoQianId;
    //                     this.muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiXuanZhongId + '\\' + this.erJiXuanZhongId + '\\';
    //                 }
    //             } else if (jiBie === 3) {
    //                 // 额外标签可多选
    //                 let xiaBiao = this.sanJiXuanZhongLieBiao.indexOf(biaoQianId)
    //                 if (xiaBiao === -1) {
    //                     this.sanJiXuanZhongLieBiao.push(biaoQianId);
    //                 } else {
    //                     this.sanJiXuanZhongLieBiao.splice(xiaBiao, 1);
    //                 }
    //             }
    //             this.chongMingMingTuPian();
    //         },
    //         chongMingMingTuPian: function () {
    //             let date = new Date();
    //             let shiJian = String(date.getFullYear());
    //             let temp = date.getMonth() + 1;
    //             shiJian += (temp < 10) ? '0' + temp : String(temp);
    //             temp = date.getDate();
    //             shiJian += (temp < 10) ? '0' + temp : String(temp);
    //             temp = date.getHours();
    //             shiJian += (temp < 10) ? '0' + temp : String(temp);
    //             temp = date.getMinutes();
    //             shiJian += (temp < 10) ? '0' + temp : String(temp);
    //             temp = date.getSeconds();
    //             shiJian += (temp < 10) ? '0' + temp : String(temp);
    //             let tuPianMingShuZu = this.tuPianLuJing.split('.');
    //             let houZhuiMing = tuPianMingShuZu[tuPianMingShuZu.length - 1];
    //             if (!gEmpty(this.erJiXuanZhongId)) {
    //                 if (!gEmpty(this.yiJiXuanZhongId)) {
    //                     this.shiJianBiaoShi = shiJian;
    //                     this.tuPianChongMingMing = this.erJiXuanZhongId + '_'
    //                         + this.tuPianKuanDu + '_' + this.tuPianGaoDu + '_' + shiJian + '.' + houZhuiMing;
    //                     this.keYiYiDong = true;
    //                 } else {
    //                     this.tuPianChongMingMing = '';
    //                     this.keYiYiDong = false;
    //                 }
    //             } else if (!gEmpty(this.yiJiXuanZhongId)) {
    //                 this.shiJianBiaoShi = shiJian;
    //                 this.tuPianChongMingMing = this.yiJiXuanZhongId + '_'
    //                     + this.tuPianKuanDu + '_' + this.tuPianGaoDu + '_' + shiJian + '.' + houZhuiMing;
    //                 this.keYiYiDong = true;
    //             } else {
    //                 this.tuPianChongMingMing = '';
    //                 this.keYiYiDong = false;
    //             }
    //         },
    //         queRenYiDong: function () {
    //             if (gEmpty(this.tuPianLuJing)) {
    //                 alert('未选择图片');
    //                 return;
    //             }
    //             let thisVue = this;
    //             let yiDongLuJing = this.muBiaoMuLu + this.tuPianChongMingMing;
    //             let fenLeiSuoYin = {
    //                 biaoShi: this.shiJianBiaoShi,
    //                 kuanDu: this.tuPianKuanDu,
    //                 gaoDu: this.tuPianGaoDu,
    //                 yiJiBiaoQianId: this.yiJiXuanZhongId,
    //                 erJiBiaoQianId: this.erJiXuanZhongId,
    //                 sanJiBiaoQianLieBiao: this.sanJiBiaoQianLieBiao,
    //                 tuPianMuLu: yiDongLuJing
    //             };
    //             let fenLeiSuoYinLieBiao = {};
    //             GFs.readFile(this.biaoQianMuLu + 'fenLeiSuoYin.json', 'utf8', function (yiChang, fenLeiSuoYinJson) {
    //                 if (yiChang === null) {
    //                     if (!gEmpty(fenLeiSuoYinJson)) {
    //                         fenLeiSuoYinLieBiao = JSON.parse(fenLeiSuoYinJson);
    //                     }
    //                     fenLeiSuoYinLieBiao[thisVue.shiJianBiaoShi] = fenLeiSuoYin;
    //                 } else {
    //                     fenLeiSuoYinLieBiao[thisVue.shiJianBiaoShi] = fenLeiSuoYin;
    //                 }
    //                 GFs.writeFileSync(thisVue.biaoQianMuLu + 'fenLeiSuoYin.json', JSON.stringify(fenLeiSuoYinLieBiao), 'utf8');
    //                 GFs.rename(thisVue.tuPianLuJing, yiDongLuJing, function (err) {
    //                     if (!gEmpty(err)) {
    //                         console.log(err);
    //                         alert('移动图片异常');
    //                     }
    //                     this.keYiYiDong = false;
    //                     let xiaBiao = thisVue.tuPianLieBiao.indexOf(thisVue.xuanZhongTuPianMing)
    //                     if (xiaBiao !== -1) {
    //                         thisVue.tuPianLieBiao.splice(xiaBiao, 1);
    //                     }
    //                     thisVue.xuanZhongTuPianMing = '';
    //                     thisVue.yiJiXuanZhongId = '';
    //                     thisVue.erJiXuanZhongId = '';
    //                     thisVue.sanJiXuanZhongLieBiao = [];
    //                 });
    //             });
    //         }
    //     }
</script>
</body>
</html>
