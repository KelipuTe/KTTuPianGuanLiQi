<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>KT图片管理器</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap-grid.min.css">
    <link rel="stylesheet" href="bootstrap-reboot.min.css">
    <link rel="stylesheet" href="font-awesome.min.css">
    <link rel="stylesheet" href="zhu_chuang_kou.css">
    <script src="jquery.min.js"></script>
    <script>
        <!--处理Electron和jQuery的冲突-->
        if (typeof module === 'object') {
            window.jQuery = window.$ = module.exports;
        }
    </script>
    <script src="bootstrap.min.js"></script>
    <script src="bootstrap.bundle.min.js"></script>
    <script src="vue.min.js"></script>
    <script src="quan_ju_chang_liang.js"></script>
    <script src="quan_ju_fang_fa.js"></script>
    <script src="you_ji_cai_dan.js"></script>
</head>
<body>
<div id="tu-pian-guan-li" class="container zhu-rong-qi">
    <tu-pian-guan-li></tu-pian-guan-li>
</div>
<template id="template-tu-pian-guan-li">
    <div class="row">
        <!--左侧-->
        <div class="col-md-2 zheng-ti-cuo-ce">
            <!--选择目录-->
            <div class="row">
                <div id="xuan-ze-mu-lu" class="btn btn-lg btn-primary btn-block" v-on:click="xuanZeMuLu">选择目录</div>
            </div>
            <div class="row">
                <ul class="list-group kuan-du-100">
                    <li class="list-group-item">操作目录：{{caoZuoMuLu}}</li>
                </ul>
            </div>
            <!--图片按钮-->
            <div class="row btn-group-vertical" role="group">
                <button type="button" class="btn btn-secondary tu-pian-an-niu" v-bind:title="tuPianMing"
                        v-for="tuPianMing in tuPianLieBiao" v-on:click="daKaiTuPian(tuPianMing)">{{tuPianMing}}
                </button>
            </div>
        </div>
        <!--中间-->
        <div class="col-md-7 zheng-ti-zhong-jian">
            <!--图片展示-->
            <div>
                <img id="tu-pian-zhan-shi" src="" v-bind:src="tuPianLuJing" v-if="zhanShiTuPian"/>
            </div>
        </div>
        <!--右侧-->
        <div class="col-md-3 zheng-ti-you-ce">
            <!--标记图片-->
            <div class="row card you-ce-ka-pian">
                <div class="card-header">
                    <button type="button" class="btn btn-warning kuan-du-100" v-on:click="queRenYiDong()" v-if="keYiYiDong">确认移动</button>
                    <button type="button" class="btn btn-warning kuan-du-100" disabled v-else="keYiYiDong">确认移动</button>
                </div>
                <div class="card-body">
                    <p>图片信息：宽度={{tuPianGaoDu}}；高度={{tuPianKuanDu}}</p>
                    <p>目标目录：{{muBiaoMuLu}}</p>
                    <p>图片将重命名为：{{tuPianChongMingMing}}</p>
                </div>
            </div>
            <!--标签-->
            <nav class="row">
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <a class="nav-item nav-link active" id="yi-ji-biao-qian-tab" data-toggle="tab"
                       href="#yi-ji-biao-qian" role="tab" aria-controls="yi-ji-biao-qian" aria-selected="true">一级标签</a>
                    <a class="nav-item nav-link" id="er-ji-biao-qian-tab" data-toggle="tab"
                       href="#er-ji-biao-qian" role="tab" aria-controls="er-ji-biao-qian" aria-selected="false">二级标签</a>
                    <a class="nav-item nav-link" id="san-ji-biao-qian-tab" data-toggle="tab"
                       href="#san-ji-biao-qian" role="tab" aria-controls="san-ji-biao-qian" aria-selected="false">额外标签</a>
                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="yi-ji-biao-qian" role="tabpanel">
                    <div class="row card">
                        <div class="card-header">一级标签</div>
                        <div class="card-body">
                            <div v-for="(valueBiaoQianMing,keyBiaoQianId) in yiJiBiaoQian">
                                <button type="button" v-bind:class="qieHuanBiaoQianYangShi(1,keyBiaoQianId)"
                                        v-on:click="xuanZhongBiaoQian(1,keyBiaoQianId)">{{valueBiaoQianMing}}
                                </button>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="一级标签ID" v-model="yiJiBiaoQianId">
                                <input type="text" class="form-control" placeholder="一级标签名" v-model="yiJiBiaoQianMing">
                                <div class="input-group-prepend">
                                    <button type="button" class="btn btn-primary" v-on:click="tianJiaBiaoQian(1)">添加标签
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="er-ji-biao-qian" role="tabpanel">
                    <div class="row card">
                        <div class="card-header">二级标签</div>
                        <div class="card-body">
                            <div v-for="(valueBiaoQianMing,keyBiaoQianId) in erJiBiaoQian">
                                <button type="button" v-bind:class="qieHuanBiaoQianYangShi(2,keyBiaoQianId)"
                                        v-on:click="xuanZhongBiaoQian(2,keyBiaoQianId)">{{valueBiaoQianMing}}
                                </button>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="二级标签ID" v-model="erJiBiaoQianId">
                                <input type="text" class="form-control" placeholder="二级标签名" v-model="erJiBiaoQianMing">
                                <div class="input-group-prepend">
                                    <button type="button" class="btn btn-primary" v-on:click="tianJiaBiaoQian(2)">添加标签
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="san-ji-biao-qian" role="tabpanel">
                    <div class="row card">
                        <div class="card-header">额外标签</div>
                        <div class="card-body">
                            <div v-for="(valueBiaoQianMing,keyBiaoQianId) in sanJiBiaoQian">
                                <button type="button" v-bind:class="qieHuanBiaoQianYangShi(3,keyBiaoQianId)"
                                        v-on:click="xuanZhongBiaoQian(3,keyBiaoQianId)">{{valueBiaoQianMing}}
                                </button>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="额外标签ID" v-model="sanJiBiaoQianId">
                                <input type="text" class="form-control" placeholder="额外标签名" v-model="sanJiBiaoQianMing">
                                <div class="input-group-prepend">
                                    <button type="button" class="btn btn-primary" v-on:click="tianJiaBiaoQian(3)">添加标签
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
    Vue.component("tu-pian-guan-li", {
        template: "#template-tu-pian-guan-li",
        data: function () {
            return {
                caoZuoMuLu: '', tuPianMuLu: '', biaoQianMuLu: '',
                tuPianShuLiang: 20, tuPianLieBiao: [], zhanShiTuPian: true, tuPianLuJing: '', xuanZhongTuPianMing: '',
                yiJiErJiFenZu: {},
                yiJiBiaoQian: {}, yiJiBiaoQianId: '', yiJiBiaoQianMing: '', yiJiXuanZhongId: '',
                erJiBiaoQian: {}, erJiBiaoQianId: '', erJiBiaoQianMing: '', erJiXuanZhongId: '',
                sanJiBiaoQian: {}, sanJiBiaoQianId: '', sanJiBiaoQianMing: '', sanJiXuanZhongLieBiao: [],
                keYiYiDong: false,
                tuPianKuanDu: 0, tuPianGaoDu: 0, muBiaoMuLu: '', tuPianChongMingMing: '',
                shiJianBiaoShi: '', fenLeiSuoYin: {}
            }
        },
        created: function () {
        },
        methods: {
            xuanZeMuLu: function () {
                // 选择操作目录
                let thisVue = this;
                GDialog.showOpenDialog({
                    'title': '请选择操作目录',
                    'properties': ['openDirectory']
                }).then(function (result) {
                    thisVue.caoZuoMuLu = result.filePaths[0];
                    thisVue.tuPianMuLu = thisVue.caoZuoMuLu + '\\' + GWeiFenLeiMuLu;
                    thisVue.biaoQianMuLu = thisVue.caoZuoMuLu + '\\' + GBiaoQianMuLu;
                    thisVue.huoQuTuPianLieBiao();
                    thisVue.huoqQuBiaoQian();
                });
            },
            huoQuTuPianLieBiao: function () {
                // 获取图片列表
                let jiShu = 1;
                let thisVue = this;
                GFs.readdir(this.tuPianMuLu, function (yiChang, wenJianLieBiao) {
                    thisVue.tuPianLieBiao = [];
                    if (yiChang === null) {
                        for (let wenJianMing of wenJianLieBiao) {
                            if (jiShu > thisVue.tuPianShuLiang) {
                                break;
                            }
                            thisVue.tuPianLieBiao.push(wenJianMing);
                            ++jiShu;
                        }
                    }
                });
            },
            daKaiTuPian: function (tuPianMing) {
                // 打开图片
                let thisVue = this;
                let tuPianLuJing = this.tuPianMuLu + '\\' + tuPianMing;
                this.xuanZhongTuPianMing = tuPianMing;
                if (this.tuPianLuJing === tuPianLuJing) {
                    // 重复打开直接跳过
                    return;
                }
                let img = new Image();
                img.onload = function () {
                    // 图片加载的时候计算偏移量，让图片居中
                    let imgWidth = img.width;
                    let imgHeight = img.height;
                    thisVue.tuPianKuanDu = imgWidth;
                    thisVue.tuPianGaoDu = imgHeight;
                    let imgMarginLeft = 0;
                    let imgMarginTop = 0;
                    if (imgWidth <= GImgMaxWidth && imgHeight <= GImgMaxHeight) {
                        // 宽高都小于限制，直接计算偏移量
                        imgMarginLeft = Math.round((GImgMaxWidth - imgWidth) / 2 * 100) / 100;
                        imgMarginTop = Math.round((GImgMaxHeight - imgHeight) / 2 * 100) / 100;
                    } else if (imgWidth <= GImgMaxWidth && imgHeight > GImgMaxHeight) {
                        // 只有宽度超过限制，单独计算高度偏移量
                        imgWidth = Math.round(imgWidth * (GImgMaxHeight / imgHeight));
                        imgMarginLeft = Math.round((GImgMaxWidth - imgWidth) / 2 * 100) / 100;
                    } else if (imgWidth > GImgMaxWidth && imgHeight <= GImgMaxHeight) {
                        // 只有高度超过限制，单独计算宽度偏移量
                        imgHeight = Math.round(imgHeight * (GImgMaxWidth / imgWidth));
                        imgMarginTop = Math.round((GImgMaxHeight - imgHeight) / 2 * 100) / 100;
                    } else if (imgWidth > GImgMaxWidth && imgHeight > GImgMaxHeight) {
                        // 只有宽高都超过限制，判断哪个超的更多，需要同比压缩
                        if ((imgWidth / GImgMaxWidth) >= (imgHeight / GImgMaxHeight)) {
                            imgHeight = Math.round(imgHeight * (GImgMaxWidth / imgWidth));
                            imgMarginTop = Math.round((GImgMaxHeight - imgHeight) / 2 * 100) / 100;
                        } else {
                            imgWidth = Math.round(imgWidth * (GImgMaxHeight / imgHeight));
                            imgMarginLeft = Math.round((GImgMaxWidth - imgWidth) / 2 * 100) / 100;
                        }
                    }
                    let eleTuPianZhanShi = document.getElementById('tu-pian-zhan-shi');
                    eleTuPianZhanShi.setAttribute('style', 'margin-left: ' + imgMarginLeft + 'px; margin-top: ' + imgMarginTop + 'px');
                };
                this.tuPianLuJing = tuPianLuJing;
                img.src = this.tuPianLuJing;
            },
            tianJiaBiaoQian: function (jiBie) {
                // 添加标签，并写入文件
                let thisVue = this;
                if (jiBie === 1) {
                    if (gEmpty(this.yiJiBiaoQianId) || gEmpty(this.yiJiBiaoQianMing)) {
                        alert('一级标签数据缺失');
                        return;
                    }
                    this.yiJiBiaoQian[this.yiJiBiaoQianId] = this.yiJiBiaoQianMing;
                    this.yiJiErJiFenZu[this.yiJiBiaoQianId] = {};
                    GFs.opendir(this.biaoQianMuLu, function (yiChang, muLu) {
                        if (yiChang !== null) {
                            GFs.mkdirSync(thisVue.biaoQianMuLu);
                        } else {
                            muLu.close();
                        }
                        GFs.writeFileSync(thisVue.biaoQianMuLu + 'yiJiBiaoQian.json', JSON.stringify(thisVue.yiJiBiaoQian), 'utf8');
                        thisVue.yiJiBiaoQianId = '';
                        thisVue.yiJiBiaoQianMing = '';
                    });
                    let muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiBiaoQianId;
                    GFs.opendir(muBiaoMuLu, function (yiChang, muLu) {
                        if (yiChang !== null) {
                            GFs.mkdirSync(muBiaoMuLu);
                        } else {
                            muLu.close();
                        }
                    });
                } else if (jiBie === 2) {
                    if (gEmpty(this.yiJiXuanZhongId)) {
                        alert('未选择一级标签');
                        return;
                    } else if (gEmpty(this.erJiBiaoQianId) || gEmpty(this.erJiBiaoQianMing)) {
                        alert('二级标签数据缺失');
                        return;
                    }
                    this.erJiBiaoQian[this.erJiBiaoQianId] = this.erJiBiaoQianMing;
                    if (gEmpty(this.yiJiErJiFenZu[this.yiJiXuanZhongId])) {
                        this.yiJiErJiFenZu[this.yiJiXuanZhongId] = {};
                    }
                    this.yiJiErJiFenZu[this.yiJiXuanZhongId][this.erJiBiaoQianId] = this.erJiBiaoQianMing;
                    GFs.opendir(this.biaoQianMuLu, function (yiChang, muLu) {
                        if (yiChang !== null) {
                            GFs.mkdirSync(thisVue.biaoQianMuLu);
                        } else {
                            muLu.close();
                        }
                        GFs.writeFileSync(thisVue.biaoQianMuLu + 'yiJiErJiFenZu.json', JSON.stringify(thisVue.yiJiErJiFenZu), 'utf8');
                        thisVue.erJiBiaoQianId = '';
                        thisVue.erJiBiaoQianMing = '';
                    });
                    let muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiXuanZhongId + '\\' + this.erJiBiaoQianId;
                    GFs.opendir(muBiaoMuLu, function (yiChang, muLu) {
                        if (yiChang !== null) {
                            GFs.mkdirSync(muBiaoMuLu);
                        } else {
                            muLu.close();
                        }
                    });
                } else if (jiBie === 3) {
                    if (gEmpty(this.sanJiBiaoQianId) || gEmpty(this.sanJiBiaoQianMing)) {
                        alert('额外标签数据缺失');
                        return;
                    }
                    this.sanJiBiaoQian[this.sanJiBiaoQianId] = this.sanJiBiaoQianMing;
                    GFs.opendir(this.biaoQianMuLu, function (yiChang, muLu) {
                        if (yiChang !== null) {
                            GFs.mkdirSync(thisVue.biaoQianMuLu);
                        } else {
                            muLu.close();
                        }
                        GFs.writeFileSync(thisVue.biaoQianMuLu + 'sanJiBiaoQian.json', JSON.stringify(thisVue.sanJiBiaoQian), 'utf8');
                        thisVue.sanJiBiaoQianId = '';
                        thisVue.sanJiBiaoQianMing = '';
                    });
                }
            },
            huoqQuBiaoQian: function () {
                // 获取保存在文件里的标签
                let thisVue = this;
                GFs.readFile(this.biaoQianMuLu + 'yiJiBiaoQian.json', 'utf8', function (yiChang, yiJiBiaoQian) {
                    if (yiChang === null) {
                        thisVue.yiJiBiaoQian = JSON.parse(yiJiBiaoQian);
                    }
                });
                GFs.readFile(this.biaoQianMuLu + 'yiJiErJiFenZu.json', 'utf8', function (yiChang, yiJiErJiFenZu) {
                    if (yiChang === null) {
                        thisVue.yiJiErJiFenZu = JSON.parse(yiJiErJiFenZu);
                    }
                });
                GFs.readFile(this.biaoQianMuLu + 'sanJiBiaoQian.json', 'utf8', function (yiChang, sanJiBiaoQian) {
                    if (yiChang === null) {
                        thisVue.sanJiBiaoQian = JSON.parse(sanJiBiaoQian);
                    }
                });
            },
            xuanZhongBiaoQian: function (jiBie, biaoQianId) {
                // 选中标签
                if (jiBie === 1) {
                    // 一级标签互斥，同时获取二级标签
                    if (this.yiJiXuanZhongId === biaoQianId) {
                        this.yiJiXuanZhongId = '';
                        this.erJiBiaoQian = {};
                        this.muBiaoMuLu = '';
                    } else {
                        this.yiJiXuanZhongId = biaoQianId;
                        this.erJiBiaoQian = gEmpty(this.yiJiErJiFenZu[biaoQianId]) ? {} : this.yiJiErJiFenZu[biaoQianId];
                        this.muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiXuanZhongId + '\\'
                            + (gEmpty(this.erJiXuanZhongId) ? '' : this.erJiXuanZhongId + '\\');
                    }
                } else if (jiBie === 2) {
                    // 二级标签互斥
                    if (this.erJiXuanZhongId === biaoQianId) {
                        this.erJiXuanZhongId = '';
                        this.muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiXuanZhongId + '\\';
                    } else {
                        this.erJiXuanZhongId = biaoQianId;
                        this.muBiaoMuLu = this.caoZuoMuLu + '\\' + this.yiJiXuanZhongId + '\\' + this.erJiXuanZhongId + '\\';
                    }
                } else if (jiBie === 3) {
                    // 额外标签可多选
                    let xiaBiao = this.sanJiXuanZhongLieBiao.indexOf(biaoQianId)
                    if (xiaBiao === -1) {
                        this.sanJiXuanZhongLieBiao.push(biaoQianId);
                    } else {
                        this.sanJiXuanZhongLieBiao.splice(xiaBiao, 1);
                    }
                }
                this.chongMingMingTuPian();
            },
            chongMingMingTuPian: function () {
                let date = new Date();
                let shiJian = String(date.getFullYear());
                let temp = date.getMonth() + 1;
                shiJian += (temp < 10) ? '0' + temp : String(temp);
                temp = date.getDate();
                shiJian += (temp < 10) ? '0' + temp : String(temp);
                temp = date.getHours();
                shiJian += (temp < 10) ? '0' + temp : String(temp);
                temp = date.getMinutes();
                shiJian += (temp < 10) ? '0' + temp : String(temp);
                temp = date.getSeconds();
                shiJian += (temp < 10) ? '0' + temp : String(temp);
                let tuPianMingShuZu = this.tuPianLuJing.split('.');
                let houZhuiMing = tuPianMingShuZu[tuPianMingShuZu.length - 1];
                if (!gEmpty(this.erJiXuanZhongId)) {
                    if (!gEmpty(this.yiJiXuanZhongId)) {
                        this.shiJianBiaoShi = shiJian;
                        this.tuPianChongMingMing = this.erJiXuanZhongId + '_'
                            + this.tuPianKuanDu + '_' + this.tuPianGaoDu + '_' + shiJian + '.' + houZhuiMing;
                        this.keYiYiDong = true;
                    } else {
                        this.tuPianChongMingMing = '';
                        this.keYiYiDong = false;
                    }
                } else if (!gEmpty(this.yiJiXuanZhongId)) {
                    this.shiJianBiaoShi = shiJian;
                    this.tuPianChongMingMing = this.yiJiXuanZhongId + '_'
                        + this.tuPianKuanDu + '_' + this.tuPianGaoDu + '_' + shiJian + '.' + houZhuiMing;
                    this.keYiYiDong = true;
                } else {
                    this.tuPianChongMingMing = '';
                    this.keYiYiDong = false;
                }
            },
            queRenYiDong: function () {
                if (gEmpty(this.tuPianLuJing)) {
                    alert('未选择图片');
                    return;
                }
                let thisVue = this;
                let yiDongLuJing = this.muBiaoMuLu + this.tuPianChongMingMing;
                let fenLeiSuoYin = {
                    biaoShi: this.shiJianBiaoShi,
                    kuanDu: this.tuPianKuanDu,
                    gaoDu: this.tuPianGaoDu,
                    yiJiBiaoQianId: this.yiJiXuanZhongId,
                    erJiBiaoQianId: this.erJiXuanZhongId,
                    sanJiBiaoQianLieBiao: this.sanJiBiaoQianLieBiao,
                    tuPianMuLu: yiDongLuJing
                };
                let fenLeiSuoYinLieBiao = {};
                GFs.readFile(this.biaoQianMuLu + 'fenLeiSuoYin.json', 'utf8', function (yiChang, fenLeiSuoYinJson) {
                    if (yiChang === null) {
                        if (!gEmpty(fenLeiSuoYinJson)) {
                            fenLeiSuoYinLieBiao = JSON.parse(fenLeiSuoYinJson);
                        }
                        fenLeiSuoYinLieBiao[thisVue.shiJianBiaoShi] = fenLeiSuoYin;
                    } else {
                        fenLeiSuoYinLieBiao[thisVue.shiJianBiaoShi] = fenLeiSuoYin;
                    }
                    GFs.writeFileSync(thisVue.biaoQianMuLu + 'fenLeiSuoYin.json', JSON.stringify(fenLeiSuoYinLieBiao), 'utf8');
                    GFs.rename(thisVue.tuPianLuJing, yiDongLuJing, function (err) {
                        if (!gEmpty(err)) {
                            console.log(err);
                            alert('移动图片异常');
                        }
                        this.keYiYiDong = false;
                        let xiaBiao = thisVue.tuPianLieBiao.indexOf(thisVue.xuanZhongTuPianMing)
                        if (xiaBiao !== -1) {
                            thisVue.tuPianLieBiao.splice(xiaBiao, 1);
                        }
                        thisVue.xuanZhongTuPianMing = '';
                        thisVue.yiJiXuanZhongId = '';
                        thisVue.erJiXuanZhongId = '';
                        thisVue.sanJiXuanZhongLieBiao = [];
                    });
                });
            }
        },
        computed: {
            qieHuanBiaoQianYangShi: function () {
                // 标签样式切换
                return function (jiBie, biaoQianId) {
                    if (jiBie === 1) {
                        if (biaoQianId === this.yiJiXuanZhongId) {
                            return 'btn btn-sm btn-success you-ce-xiao-an-niu';
                        } else {
                            return 'btn btn-sm btn-primary you-ce-xiao-an-niu';
                        }
                    } else if (jiBie === 2) {
                        if (biaoQianId === this.erJiXuanZhongId) {
                            return 'btn btn-sm btn-success you-ce-xiao-an-niu';
                        } else {
                            return 'btn btn-sm btn-primary you-ce-xiao-an-niu';
                        }
                    } else if (jiBie === 3) {
                        if (this.sanJiXuanZhongLieBiao.indexOf(biaoQianId) !== -1) {
                            return 'btn btn-sm btn-success you-ce-xiao-an-niu';
                        } else {
                            return 'btn btn-sm btn-primary you-ce-xiao-an-niu';
                        }
                    }
                }
            }
        }
    });
    new Vue({el: "#tu-pian-guan-li"});
</script>
</body>
</html>
