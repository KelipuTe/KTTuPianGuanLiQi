<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>KT图片管理器</title>
    <link rel="stylesheet" href="bu_ju.css">
    <link rel="stylesheet" href="zu_jian.css">
    <script src="quan_ju.js"></script>
    <script src="you_ji_cai_dan.js"></script>
</head>
<body>
<div class="zhu-rong-qi">
    <div class="zheng-ti-zuo">
        <div>
            <button id="xuan-ze-mu-lu" type="button" class="an-niu-zhong an-niu-lan">选择目录</button>
            <div id="mu-lu-lu-jing"></div>
        </div>
        <div id="tu-pian-lie-biao"></div>
    </div>
    <div class="zheng-ti-zhong">
        <img id="tu-pian-zhan-shi" src="" alt="图片展示">
    </div>
    <div class="zheng-ti-you">
        <div id="biao-qian-lie-biao" class="biao-qian-lie-biao">
            <label class="biao-qian-an-niu">
                <span>分类标签</span>
            </label>
            <label class="biao-qian-an-niu">
                <span>额外标签</span>
            </label>
        </div>
        <div id="biao-qian-yei-lie-biao" class="biao-qian-yei-lie-biao">
            <div style="display: block">
                <div style="height: 20px">
                    一级分类标签
                </div>
                <div id="yi-ji-lie-biao" style="height: 250px">

                </div>
                <div style="height: 30px">
                    <input id="yi-ji-id" type="text" style="width: 80px" aria-label="一级Id"/>
                    <input id="yi-ji-ming" type="text" style="width: 80px" aria-label="一级标签名"/>
                    <button id="yi-ji-tian-jia" type="button" class="an-niu-zhong button-lan">添加一级标签</button>
                </div>
                <div style="height: 20px">
                    二级分类标签
                </div>
                <div id="er-ji-lie-biao" style="height: 250px">

                </div>
                <div style="height: 30px">
                    <input id="er-ji-id" type="text" style="width: 80px" aria-label="二级Id"/>
                    <input id="er-ji-ming" type="text" style="width: 80px" aria-label="二级标签名"/>
                    <button id="er-ji-tian-jia" type="button" class="an-niu-zhong button-lan">添加二级标签</button>
                </div>
            </div>
            <div style="display: none">额外标签</div>
        </div>
        <div><span id="mu-biao-lu-jing"></span></div>
        <div>确认移动</div>
    </div>
</div>
<script>
    // 目录变量
    let caoZuoMuLu = '';
    let tuPianMuLu = '';
    let biaoQianMuLu = '';
    let muBiaoMuLu = '';
    // 图片列表变量
    let tuPianLieBiao = [];
    let tuPianShuLiang = 20;
    // 图片列表dom对象
    let eleXuanZeMuLu = {};
    let eleTuPianLieBiao = {};
    // 图片变量
    let tuPianLuJing = '';
    let tuPianKuanDu = 0;
    let tuPianGaoDu = 0;

    let shiJianBiaoShi = '';

    let tuPianChongMingMing = '';
    let keYiYiDong = false;
    // 图片对象
    let eleTuPianZhanShi = {};
    // 标签页变量
    let biaoQianLieBiao = {};
    let biaoQianYeLieBiao = {};

    let yiJiBiaoQian = {};
    let yiJiErJiFenZu = {};
    let erJiBiaoQian = {};
    let sanJiBiaoQian = {};

    let yiJiXuanZhongId = '';
    let erJiXuanZhongId = '';
    let sanJiXuanZhongIdLieBiao = [];
    // 标签页dom对象
    let eleYiJiBiaoQian = {};
    let eleYiJiIdShuRu = {};
    let eleYiJiMingShuRu = {};
    let eleYiJiTianJia = {};

    let eleErJiBiaoQian = {};
    let eleErJiIdShuRu = {};
    let eleErJiMingShuRu = {};
    let eleErJiTianJia = {};

    let eleMuBiaoLuJing = {};

    window.onload = function () {
        // 页面初始化
        eleXuanZeMuLu = document.getElementById('xuan-ze-mu-lu');
        eleXuanZeMuLu.onclick = dianJiXuanZeMuLu;
        eleTuPianLieBiao = document.getElementById('tu-pian-lie-biao');
        // 图片展示
        eleTuPianZhanShi = document.getElementById('tu-pian-zhan-shi');
        eleTuPianZhanShi.onload = jiaZaiTuPian;
        // 初始化标签页切换
        biaoQianLieBiao = document.getElementById('biao-qian-lie-biao').children;
        biaoQianYeLieBiao = document.getElementById('biao-qian-yei-lie-biao').children;
        for (let i = 0; i < biaoQianLieBiao.length; i++) {
            biaoQianLieBiao[i].id = 'biao-qian-' + i;
            biaoQianLieBiao[i].onclick = function () {
                for (let j = 0; j < biaoQianLieBiao.length; j++) {
                    biaoQianLieBiao[j].className = 'biao-qian-an-niu';
                    biaoQianYeLieBiao[j].style.display = 'none';
                }
                let idIndex = this.id.replace('biao-qian-', '');
                biaoQianYeLieBiao[idIndex].style.display = 'block';
            }
        }

        eleYiJiBiaoQian = document.getElementById('yi-ji-lie-biao');
        eleYiJiIdShuRu = document.getElementById('yi-ji-id');
        eleYiJiMingShuRu = document.getElementById('yi-ji-ming');
        eleYiJiTianJia = document.getElementById('yi-ji-tian-jia');
        eleYiJiTianJia.onclick = dianJiTianJiaBiaoQian;

        eleErJiBiaoQian = document.getElementById('er-ji-lie-biao');
        eleErJiIdShuRu = document.getElementById('er-ji-id');
        eleErJiMingShuRu = document.getElementById('er-ji-ming');
        eleErJiTianJia = document.getElementById('er-ji-tian-jia');
        eleErJiTianJia.onclick = dianJiTianJiaBiaoQian;

        eleMuBiaoLuJing = document.getElementById('mu-biao-lu-jing');
    }

    function dianJiXuanZeMuLu() {
        // 点击选择目录
        GDialog.showOpenDialog({
            'title': '请选择操作目录',
            'properties': ['openDirectory']
        }).then(function (result) {
            caoZuoMuLu = result.filePaths[0];
            tuPianMuLu = caoZuoMuLu + '\\' + GWeiFenLeiMuLu;
            biaoQianMuLu = caoZuoMuLu + '\\' + GBiaoQianMuLu;
            huoQuTuPianLieBiao();
            huoQuBiaoQian();
        });
    }

    function huoQuTuPianLieBiao() {
        // 获取图片列表
        let jiShu = 1;
        GFs.readdir(tuPianMuLu, function (yiChang, wenJianLieBiao) {
            // 先初始化
            tuPianLieBiao = [];
            eleTuPianLieBiao.innerHTML = '';
            if (yiChang === null) {
                // 没有异常就继续
                for (let wenJianMing of wenJianLieBiao) {
                    if (jiShu > tuPianShuLiang) {
                        break;
                    }
                    tuPianLieBiao.push(wenJianMing);
                    // 构造图片列表按钮
                    let tempEle = document.createElement('button');
                    tempEle.id = 'tu-pian-lie-biao-' + jiShu;
                    tempEle.type = 'button';
                    tempEle.className = 'an-niu-tu-pian';
                    tempEle.innerHTML = wenJianMing;
                    tempEle.onclick = dianJiXuanZeTuPian;
                    eleTuPianLieBiao.appendChild(tempEle);
                    ++jiShu;
                }
            }
        });
    }

    function dianJiXuanZeTuPian() {
        // 点击选择图片
        let wenJianMing = this.textContent;
        tuPianLuJing = tuPianMuLu + '\\' + wenJianMing;
        eleTuPianZhanShi.src = tuPianLuJing;
    }

    function jiaZaiTuPian() {
        // 图片加载的时候计算偏移量，让图片居中
        let imgWidth = this.width;
        let imgHeight = this.height;
        tuPianKuanDu = imgWidth;
        tuPianGaoDu = imgHeight;
        let imgMarginLeft = 0;
        let imgMarginTop = 0;
        if (imgWidth <= GImgMaxWidth && imgHeight <= GImgMaxHeight) {
            // 宽高都小于限制，直接计算偏移量
            imgMarginLeft = Math.round((GImgMaxWidth - imgWidth) / 2 * 100) / 100;
            imgMarginTop = Math.round((GImgMaxHeight - imgHeight) / 2 * 100) / 100;
        } else if (imgWidth <= GImgMaxWidth && imgHeight > GImgMaxHeight) {
            // 只有宽度超过限制，单独计算高度偏移量
            imgWidth = Math.round(imgWidth * (GImgMaxHeight / imgHeight));
            imgMarginLeft = Math.round((GImgMaxWidth - imgWidth) / 2 * 100) / 100;
        } else if (imgWidth > GImgMaxWidth && imgHeight <= GImgMaxHeight) {
            // 只有高度超过限制，单独计算宽度偏移量
            imgHeight = Math.round(imgHeight * (GImgMaxWidth / imgWidth));
            imgMarginTop = Math.round((GImgMaxHeight - imgHeight) / 2 * 100) / 100;
        } else if (imgWidth > GImgMaxWidth && imgHeight > GImgMaxHeight) {
            // 只有宽高都超过限制，判断哪个超的更多，需要同比压缩
            if ((imgWidth / GImgMaxWidth) >= (imgHeight / GImgMaxHeight)) {
                imgHeight = Math.round(imgHeight * (GImgMaxWidth / imgWidth));
                imgMarginTop = Math.round((GImgMaxHeight - imgHeight) / 2 * 100) / 100;
            } else {
                imgWidth = Math.round(imgWidth * (GImgMaxHeight / imgHeight));
                imgMarginLeft = Math.round((GImgMaxWidth - imgWidth) / 2 * 100) / 100;
            }
        }
        this.setAttribute('style', 'margin-left: ' + imgMarginLeft + 'px; margin-top: ' + imgMarginTop + 'px');
    }

    function dianJiTianJiaBiaoQian() {
        // 点击添加标签
        let eleId = this.id;
        if (eleId === 'yi-ji-tian-jia') {
            // 添加一级标签
            let xinBianQianId = eleYiJiIdShuRu.value;
            let xinBiaoQianMing = eleYiJiMingShuRu.value;
            if (gEmpty(xinBianQianId) || gEmpty(xinBiaoQianMing)) {
                alert('一级标签数据缺失');
                return;
            }
            yiJiBiaoQian[xinBianQianId] = xinBiaoQianMing;
            yiJiErJiFenZu[xinBianQianId] = {};
            // 保存标签数据
            GFs.opendir(biaoQianMuLu, function (yiChang, muLu) {
                if (yiChang !== null) {
                    GFs.mkdirSync(biaoQianMuLu);
                } else {
                    muLu.close();
                }
                GFs.writeFileSync(biaoQianMuLu + 'yiJiBiaoQian.json', JSON.stringify(yiJiBiaoQian), 'utf8');
                // 重置输入框
                eleYiJiIdShuRu.value = '';
                eleYiJiMingShuRu.value = '';
            });
            // 创建标签对应目录
            let muBiaoMuLu = caoZuoMuLu + '\\' + xinBianQianId
            GFs.opendir(muBiaoMuLu, function (yiChang, muLu) {
                if (yiChang !== null) {
                    GFs.mkdirSync(muBiaoMuLu);
                } else {
                    muLu.close();
                }
            });
            gouZaoYiJiBiaoQian();
        } else if (eleId === 'er-ji-tian-jia') {
            // 添加二级标签
            if (gEmpty(yiJiXuanZhongId)) {
                alert('未选择一级标签');
                return;
            }
            let xinBianQianId = eleErJiIdShuRu.value;
            let xinBiaoQianMing = eleErJiMingShuRu.value;
            if (gEmpty(xinBianQianId) || gEmpty(xinBiaoQianMing)) {
                alert('二级标签数据缺失');
                return;
            }
            erJiBiaoQian[xinBianQianId] = xinBiaoQianMing;
            if (gEmpty(yiJiErJiFenZu[yiJiXuanZhongId])) {
                yiJiErJiFenZu[yiJiXuanZhongId] = {};
            }
            yiJiErJiFenZu[yiJiXuanZhongId][xinBianQianId] = xinBiaoQianMing;
            // 保存标签数据
            GFs.opendir(biaoQianMuLu, function (yiChang, muLu) {
                if (yiChang !== null) {
                    GFs.mkdirSync(biaoQianMuLu);
                } else {
                    muLu.close();
                }
                GFs.writeFileSync(biaoQianMuLu + 'yiJiErJiFenZu.json', JSON.stringify(yiJiErJiFenZu), 'utf8');
                // 重置输入框
                eleErJiIdShuRu.value = '';
                eleErJiMingShuRu.value = '';
            });
            // 创建标签对应目录
            let muBiaoMuLu = caoZuoMuLu + '\\' + yiJiXuanZhongId + '\\' + xinBianQianId;
            GFs.opendir(muBiaoMuLu, function (yiChang, muLu) {
                if (yiChang !== null) {
                    GFs.mkdirSync(muBiaoMuLu);
                } else {
                    muLu.close();
                }
            });
            gouZaoErJiBiaoQian();
        }
    }

    function dianJiFenLeiBiaoQian() {
        // 点击分类标签
        let biaoQianJiBie = this.getAttribute('data-level');
        if (biaoQianJiBie === 'yi-ji') {
            // 一级标签互斥，同时获取二级标签
            if (yiJiXuanZhongId === this.id) {
                yiJiXuanZhongId = '';
                erJiBiaoQian = {};
                muBiaoMuLu = '';
            } else {
                yiJiXuanZhongId = this.id;
                gouZaoErJiBiaoQian();
                muBiaoMuLu = caoZuoMuLu + '\\' + yiJiXuanZhongId + '\\'
                    + (gEmpty(erJiXuanZhongId) ? '' : erJiXuanZhongId + '\\');
            }
        } else if (biaoQianJiBie === 'er-ji') {
            // 二级标签互斥
            if (erJiXuanZhongId === this.id) {
                erJiXuanZhongId = '';
                muBiaoMuLu = caoZuoMuLu + '\\' + yiJiXuanZhongId + '\\';
            } else {
                erJiXuanZhongId = this.id;
                muBiaoMuLu = caoZuoMuLu + '\\' + yiJiXuanZhongId + '\\' + erJiXuanZhongId + '\\';
            }
        }
        chongMingMingTuPian();
        eleMuBiaoLuJing.innerHTML = muBiaoMuLu + tuPianChongMingMing;
    }

    function gouZaoYiJiBiaoQian() {
        eleYiJiBiaoQian.innerHTML = '';
        for (let kBiaoQian in yiJiBiaoQian) {
            // 构造一级分类标签按钮
            let tempEle = document.createElement('button');
            tempEle.id = kBiaoQian
            tempEle.type = 'button';
            tempEle.innerHTML = yiJiBiaoQian[kBiaoQian];
            tempEle.className = 'an-niu-xiao an-niu-lan';
            tempEle.setAttribute('data-level', 'yi-ji');
            // 绑定标签点击事件
            tempEle.onclick = dianJiFenLeiBiaoQian;
            eleYiJiBiaoQian.appendChild(tempEle);
        }
    }

    function gouZaoErJiBiaoQian() {
        eleErJiBiaoQian.innerHTML = '';
        erJiBiaoQian = gEmpty(yiJiErJiFenZu[yiJiXuanZhongId]) ? {} : yiJiErJiFenZu[yiJiXuanZhongId];
        for (let kBiaoQian2 in erJiBiaoQian) {
            // 构造二级分类标签按钮
            let tempEle = document.createElement('button');
            tempEle.id = kBiaoQian2;
            tempEle.type = 'button';
            tempEle.innerHTML = erJiBiaoQian[kBiaoQian2];
            tempEle.className = 'an-niu-xiao an-niu-lan';
            tempEle.setAttribute('data-level', 'er-ji');
            // 绑定标签点击事件
            tempEle.onclick = dianJiFenLeiBiaoQian;
            eleErJiBiaoQian.appendChild(tempEle);
        }
    }

    function chongMingMingTuPian() {
        let date = new Date();
        let shiJian = String(date.getFullYear());
        let tempMing = date.getMonth() + 1;
        shiJian += (tempMing < 10) ? '0' + tempMing : String(tempMing);
        tempMing = date.getDate();
        shiJian += (tempMing < 10) ? '0' + tempMing : String(tempMing);
        tempMing = date.getHours();
        shiJian += (tempMing < 10) ? '0' + tempMing : String(tempMing);
        tempMing = date.getMinutes();
        shiJian += (tempMing < 10) ? '0' + tempMing : String(tempMing);
        tempMing = date.getSeconds();
        shiJian += (tempMing < 10) ? '0' + tempMing : String(tempMing);
        let tuPianMingShuZu = tuPianLuJing.split('.');
        let houZhuiMing = tuPianMingShuZu[tuPianMingShuZu.length - 1];
        if (!gEmpty(erJiXuanZhongId)) {
            if (!gEmpty(yiJiXuanZhongId)) {
                shiJianBiaoShi = shiJian;
                tuPianChongMingMing = erJiXuanZhongId + '_'
                    + tuPianKuanDu + '_' + tuPianGaoDu + '_' + shiJian + '.' + houZhuiMing;
                keYiYiDong = true;
            } else {
                tuPianChongMingMing = '';
                keYiYiDong = false;
            }
        } else if (!gEmpty(yiJiXuanZhongId)) {
            shiJianBiaoShi = shiJian;
            tuPianChongMingMing = yiJiXuanZhongId + '_'
                + tuPianKuanDu + '_' + tuPianGaoDu + '_' + shiJian + '.' + houZhuiMing;
            keYiYiDong = true;
        } else {
            tuPianChongMingMing = '';
            keYiYiDong = false;
        }
    }

    function huoQuBiaoQian() {
        // 获取保存在文件里的标签
        GFs.readFile(biaoQianMuLu + 'yiJiBiaoQian.json', 'utf8', function (yiChang, yiJiBiaoQianJson) {
            if (yiChang === null) {
                yiJiBiaoQian = JSON.parse(yiJiBiaoQianJson);
                gouZaoYiJiBiaoQian();
            }
        });
        GFs.readFile(biaoQianMuLu + 'yiJiErJiFenZu.json', 'utf8', function (yiChang, yiJiErJiFenZuJson) {
            if (yiChang === null) {
                yiJiErJiFenZu = JSON.parse(yiJiErJiFenZuJson);
            }
        });
        GFs.readFile(biaoQianMuLu + 'sanJiBiaoQian.json', 'utf8', function (yiChang, sanJiBiaoQianJson) {
            if (yiChang === null) {
                sanJiBiaoQian = JSON.parse(sanJiBiaoQianJson);
            }
        });
    }
</script>
<script>
    //         tianJiaBiaoQian: function (jiBie) {
    //             // 添加标签，并写入文件
    //             else if (jiBie === 3) {
    //                 if (gEmpty(this.sanJiBiaoQianId) || gEmpty(this.sanJiBiaoQianMing)) {
    //                     alert('额外标签数据缺失');
    //                     return;
    //                 }
    //                 this.sanJiBiaoQian[this.sanJiBiaoQianId] = this.sanJiBiaoQianMing;
    //                 GFs.opendir(this.biaoQianMuLu, function (yiChang, muLu) {
    //                     if (yiChang !== null) {
    //                         GFs.mkdirSync(thisVue.biaoQianMuLu);
    //                     } else {
    //                         muLu.close();
    //                     }
    //                     GFs.writeFileSync(thisVue.biaoQianMuLu + 'sanJiBiaoQian.json', JSON.stringify(thisVue.sanJiBiaoQian), 'utf8');
    //                     thisVue.sanJiBiaoQianId = '';
    //                     thisVue.sanJiBiaoQianMing = '';
    //                 });
    //             }
    //         },
    //         xuanZhongBiaoQian: function (jiBie, biaoQianId) {
    //             // 选中标签
    //             else if (jiBie === 3) {
    //                 // 额外标签可多选
    //                 let xiaBiao = this.sanJiXuanZhongLieBiao.indexOf(biaoQianId)
    //                 if (xiaBiao === -1) {
    //                     this.sanJiXuanZhongLieBiao.push(biaoQianId);
    //                 } else {
    //                     this.sanJiXuanZhongLieBiao.splice(xiaBiao, 1);
    //                 }
    //             }
    //             this.chongMingMingTuPian();
    //         },
    //         queRenYiDong: function () {
    //             if (gEmpty(this.tuPianLuJing)) {
    //                 alert('未选择图片');
    //                 return;
    //             }
    //             let thisVue = this;
    //             let yiDongLuJing = this.muBiaoMuLu + this.tuPianChongMingMing;
    //             let fenLeiSuoYin = {
    //                 biaoShi: this.shiJianBiaoShi,
    //                 kuanDu: this.tuPianKuanDu,
    //                 gaoDu: this.tuPianGaoDu,
    //                 yiJiBiaoQianId: this.yiJiXuanZhongId,
    //                 erJiBiaoQianId: this.erJiXuanZhongId,
    //                 sanJiBiaoQianLieBiao: this.sanJiBiaoQianLieBiao,
    //                 tuPianMuLu: yiDongLuJing
    //             };
    //             let fenLeiSuoYinLieBiao = {};
    //             GFs.readFile(this.biaoQianMuLu + 'fenLeiSuoYin.json', 'utf8', function (yiChang, fenLeiSuoYinJson) {
    //                 if (yiChang === null) {
    //                     if (!gEmpty(fenLeiSuoYinJson)) {
    //                         fenLeiSuoYinLieBiao = JSON.parse(fenLeiSuoYinJson);
    //                     }
    //                     fenLeiSuoYinLieBiao[thisVue.shiJianBiaoShi] = fenLeiSuoYin;
    //                 } else {
    //                     fenLeiSuoYinLieBiao[thisVue.shiJianBiaoShi] = fenLeiSuoYin;
    //                 }
    //                 GFs.writeFileSync(thisVue.biaoQianMuLu + 'fenLeiSuoYin.json', JSON.stringify(fenLeiSuoYinLieBiao), 'utf8');
    //                 GFs.rename(thisVue.tuPianLuJing, yiDongLuJing, function (err) {
    //                     if (!gEmpty(err)) {
    //                         console.log(err);
    //                         alert('移动图片异常');
    //                     }
    //                     this.keYiYiDong = false;
    //                     let xiaBiao = thisVue.tuPianLieBiao.indexOf(thisVue.xuanZhongTuPianMing)
    //                     if (xiaBiao !== -1) {
    //                         thisVue.tuPianLieBiao.splice(xiaBiao, 1);
    //                     }
    //                     thisVue.xuanZhongTuPianMing = '';
    //                     thisVue.yiJiXuanZhongId = '';
    //                     thisVue.erJiXuanZhongId = '';
    //                     thisVue.sanJiXuanZhongLieBiao = [];
    //                 });
    //             });
    //         }
    //     }
</script>
</body>
</html>
